# Установка {#title}

## Проверьте, поддерживается ли ваше устройство {#check-if-supported}

Скачайте приложение менеджера KernelSU с сайта [GitHub Releases](https://github.com/tiann/KernelSU/releases) и установите его на устройство:

- Если приложение показывает `Unsupported`, это означает, что **Вы должны скомпилировать ядро самостоятельно**, KernelSU не будет и никогда не предоставит Вам загрузочный образ для прошивки.
- Если приложение показывает `Не установлено`, значит, ваши устройства официально поддерживаются KernelSU.

:::info
Для устройств, показывающих `Unsupported`, здесь находится [Unofficially-support-devices](unofficially-support-devices.md), вы можете скомпилировать ядро самостоятельно.
:::

## Резервное копирование стокового файла boot.img {#backup-boot-image}

Перед прошивкой необходимо создать бекап файла boot.img. Если возникнет bootloop или другие траблы в загрузке Android, вы всегда сможете восстановить систему, перепрошив boot на стоковый с помощью fastboot.

::: warning
Прошивка может привести к потере данных, поэтому обязательно выполните этот шаг перед переходом к следующему!!! При необходимости можно также создать бекап всей userdata.
:::

## Необходимые знания {#acknowage}

### ADB и fastboot {#adb-and-fastboot}

По умолчанию в этом руководстве вы будете использовать ADB и fastboot, поэтому, если вы их не знаете, рекомендуем сначала воспользоваться гуглом, чтобы узнать как ими пользоватся.

### KMI

Kernel Module Interface (KMI), версии ядра с одинаковым KMI **совместимы** Это то, что в GKI означает "общий"; и наоборот, если KMI отличается, то эти ядра несовместимы друг с другом, и прошивка образа ядра с другим KMI, чем у вашего устройства, может привести к bootloop.

В частности, для устройств GKI формат версии ядра должен быть следующим:

```txt
KernelRelease :=
Version.PatchLevel.SubLevel-AndroidRelease-KmiGeneration-suffix
w      .x         .y       -zzz           -k            -something
```

`w.x-zz-k` - версия KMI. Например, если версия ядра устройства `5.10.101-android12-9-g30979850fc20`, то его KMI - `5.10-android12-9`; теоретически оно может нормально загружаться с другими ядрами с такой же версией KMI.

::: tip
Обратите внимание, что patch значение в версии ядра не является частью KMI! Это означает, что `5.10.101-android12-9-g30979850fc20` имеет тот же KMI, что и `5.10.137-android12-9-g30979850fc20` (одинаковые major и minor версии)!
:::

### Версия ядра и версия Android {#kernel-version-vs-android-version}

Обратите внимание: **Версия ядра и версия Android - это не обязательно одно и то же!**

Если вы заметили, что версия ядра `android12-5.10.101`, а версия Android - 13 или другая, не удивляйтесь, поскольку номер версии Android не обязательно совпадает с версией ядра Linux; Версия ядра Linux обычно соответствует версии Android, поставляемой с **устройством с завода**. При последующем обновлении Android версия ядра, как правило, не меняется. При необходимости прошивки **укажите версию ядра!!!**.

## Введение {#installation-introduction}

Существует несколько способов установки KernelSU, каждый из которых подходит для разных сценариев, поэтому выбирайте их по своему усмотрению.

1. Установка с помощью кастомного Recovery (например, TWRP)
2. Установка с помощью приложения для прошивки ядра, например, Franco Kernel Manager
3. Установка с помощью fastboot с использованием boot.img, предоставленного KernelSU
4. Перепаковать boot.img вручную и установить его

## Установка с помощью кастомного Recovery {#install-by-recovery}

Необходимые условия: На устройстве должен быть установлен кастомный Recovery; если его нет или доступен только официальный, воспользуйтесь другим способом.

Шаг:

1. С [Release page](https://github.com/tiann/KernelSU/releases) KernelSU загрузите zip-архив, начинающийся с AnyKernel3, который соответствует версии Android на вашем телефоне; например, версия ядра - `android12-5.10. 66`, то следует скачать `AnyKernel3-android12-5.10.66_yyy-MM.zip` (где `yyyy` - год, а `MM` - месяц).
2. Перезагрузите телефон в TWRP.
3. С помощью adb поместите AnyKernel3-*.zip в /sdcard телефона и выберите Install Zip в TWRP; или вы можете напрямую установить через `adb sideload AnyKernel-*.zip`.

PS. Данный способ подходит для любой установки (не ограничиваясь начальной или последующими обновлениями), если вы используете TWRP.

## Установка с помощью Kernel Flasher {#install-by-kernel-flasher}

Необходимые условия: Ваше устройство должно быть рутированным. Например, Magisk, или старая версию KernelSU; если ваше устройство не рутированно, пробуйте следующий метод.

Шаги:

1. Загрузите zip-архив AnyKernel3; инструкции по загрузке см. в разделе *Установка с помощью пользовательского Recovery*.
2. Откройте приложение для прошивки ядра и используйте скачанный zip AnyKernel3 для прошивки.

Если вы раньше не использовали приложение для прошивки ядра, то наиболее популярными являются следующие.

1. [Kernel Flasher](https://github.com/capntrips/KernelFlasher/releases)
2. [Franco Kernel Manager](https://play.google.com/store/apps/details?id=com.franco.kernel)
3. [Ex Kernel Manager](https://play.google.com/store/apps/details?id=flar2.exkernelmanager)

PS. Этот способ более удобен при обновлении KernelSU и может быть выполнен без компьютера (сначала сделайте резервную копию!). .

## Установка с помощью boot.img, предоставленного KernelSU {#install-by-kernelsu-boot-image}

Этот способ не требует наличия TWRP и root-прав на телефоне; он подходит для первой установки KernelSU.

### Найти подходящий boot.img {#found-propery-image}

KernelSU предоставляет общий boot.img для устройств GKI, и его необходимо прошить в загрузочный раздел устройства.

Вы можете загрузить boot.img с [GitHub Release](https://github.com/tiann/KernelSU/releases), обратите внимание, что вы должны использовать правильную версию boot.img. Например, если на устройстве установлено ядро `android12-5.10.101`, то необходимо загрузить `android-5.10.101_yyy-MM.boot-<format>.img`. (Соблюдайте за соответствием версий KMI!).

Где `<format>` означает формат сжатия ядра в стоковом boot.img, проверьте формат сжатия ядра в сток boot.img, вы должны использовать правильный формат, например, `lz4`, `gz`; если вы используете неправильный формат сжатия, вы можете попасть в bootloop.

::: info
1. Вы можете использовать magiskboot для получения формата сжатия исходной загрузки; но вы также можете спросить других, более опытных ребят с той же моделью, что и ваше устройство. Кроме того, формат сжатия ядра обычно не меняется, поэтому, если вы успешно загрузились с определенным форматом сжатия, вы можете попробовать этот формат позже.
2. Устройства Xiaomi обычно используют `gz` или **без сжатия**.
3. Для устройств Pixel следуйте приведенным ниже инструкциям.
:::

### Прошивка boot.img на устройство {#flash-boot-image}

Используйте `adb` для подключения к устройству, затем выполните `adb reboot bootloader` для перезагрузки в fastboot, после чего используйте `fastboot flash boot boot.img` для прошивки KernelSU

::: info
Если устройство поддерживает `fastboot boot`, можно сначала использовать `fastboot boot boot.img`, чтобы загрузится с KernelSU ядром без модификации стоковой прошивки.
:::

### Перезагрузка {#reboot}

После завершения прошивки необходимо перезагрузить устройство:

```sh
fastboot reboot
```

## Исправление boot.img ручками {#patch-boot-image}

Для некоторых устройств формат boot.img не так распространен, например, не в формате `lz4`, `gz` или вообще несжатый; наиболее типичным является Pixel, его boot.img имеет формат `lz4_legacy` со сжатием, ramdisk может быть в `gz`, также может быть в `lz4_legacy` со сжатием; в это время, если напрямую прошить boot.img, предоставляемый KernelSU, телефон может не загрузиться или упасть в bootloop; в такой ситуации можно ручками исправить boot.img.

Как правило, существует два способа исправления:

1. [Android-Image-Kitchen](https://forum.xda-developers.com/t/tool-android-image-kitchen-unpack-repack-kernel-ramdisk-win-android-linux-mac.2073775/)
2. [magiskboot](https://github.com/topjohnwu/Magisk/releases)

Среди них Android-Image-Kitchen(AIK) подходит для работы на ПК, а magiskboot нуждается в участии телефона.

### Подготовка {#patch-preparation}

1. Получите стоковый boot.img вашего телефона; его можно получить у производителя устройства или из файлов стоковой прошивки, возможно, вам понадобится [payload-dumper-go](https://github.com/ssut/payload-dumper-go)
2. Загрузите zip-файл AnyKernel3, предоставленный KernelSU, который соответствует версии KMI вашего устройства (можно обратиться к разделу *Установка с помощью пользовательского Recovery*).
3. Распакуйте архив AnyKernel3, `Image` - ядро KernelSU.

### Использование Android-Image-Kitchen {#using-android-image-kitchen}

1. Загрузите AIK на свой компьютер.
2. Поместите файл boot.img в корневую папку AIK.
3. Выполните `./unpackimg.sh boot.img` в корне AIK, после чего boot.img распакуется и появятся его файлы.
4. Замените `boot.img-kernel` в каталоге `split_img` тем, который вы извлекли из AnyKernel3 (обратите внимание на изменение названия на boot.img-kernel).
5. Выполните `./repackimg.sh` в корневом каталоге 在 AIK; Вы получите файл с именем `image-new.img`; Прошейте этот boot.img с помощью fastboot (см. предыдущий раздел).

### Использование magiskboot {#using magiskboot}

1. Загрузите последнюю версию Magisk с [Release Page](https://github.com/topjohnwu/Magisk/releases).
2. Переименуйте `Magisk-*(version).apk` в `Magisk-*.zip` и разархивируйте его.
3. Закачайте `Magisk-*/lib/arm64-v8a/libmagiskboot.so` на устройство с помощью adb: `adb push Magisk-*/lib/arm64-v8a/libmagiskboot.so /data/local/tmp/magiskboot`.
4. Прошейте стоковый boot.img и образ из AnyKernel3.
5. В adb shell перейдите в каталог `/data/local/tmp/`, затем `chmod +x magiskboot`.
6. В том же adb shell и перейдите в `/data/local/tmp/`, выполните команду `./magiskboot unpack boot.img` для распаковки `boot.img`, вы получите файл `kernel`, это и есть ваше стоковое ядро.
7. Замените переименуйте `kernel` в `Image`: `mv -f Image kernel`.
8. Выполните команду `./magiskboot repack boot.img`, чтобы перепаковать boot.img, получив файл `new-boot.img`, прошейте его на устройство с помощью fastboot.

## Другие методы {#other-methods}

На самом деле все эти способы установки имеют только одну основную идею - **заменить исходное ядро на ядро, предоставляемое KernelSU**; если это возможно, то установка возможна; например, возможны следующие способы.

1. Сначала установить Magisk, получить права root через Magisk, а затем с помощью kernel flasher прошить AnyKernel zip из KernelSU.
2. Использовать какой-либо инструментарий для прошивки на ПК, чтобы прошить ядро, предоставленное KernelSU.
